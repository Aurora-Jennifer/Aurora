# Data Sanity Configuration
# Controls data validation and repair behavior

# Profiles for different validation modes
profiles:
  default:
    mode: "warn"              # Production default - gentle behavior
    price_max: 1000000.0
    allow_repairs: true
    allow_winsorize: true
    allow_clip_prices: true
    allow_fix_ohlc: true
    allow_drop_dupes: true
    allow_ffill_nans: true
    tolerate_outliers_after_repair: true
    fail_on_lookahead_flag: false
    fail_if_any_repair: false

  strict:
    mode: "fail"              # Verification profile - zero tolerance
    price_max: 1000000.0
    allow_repairs: false
    allow_winsorize: false
    allow_clip_prices: false
    allow_fix_ohlc: false
    allow_drop_dupes: false
    allow_ffill_nans: false
    tolerate_outliers_after_repair: false
    fail_on_lookahead_flag: true  # Re-enabled for testing
    fail_if_any_repair: true

  walkforward:
    mode: "warn"              # Walkforward testing profile - allow repairs
  walkforward_ci:
    mode: "enforce"
    allow_repairs: true
    allow_winsorize: true
    allow_clip_prices: true
    allow_fix_ohlc: true
    allow_drop_dupes: true
    allow_ffill_nans: true
    tolerate_outliers_after_repair: true
    fail_on_lookahead_flag: true
    fail_if_any_repair: false
    # Time-series strictness
    require_monotonic_dates: true
    tz: "UTC"
    price_max: 1000000.0

  # Relaxed profile specifically for Smoke CI runs
  walkforward_smoke:
    mode: "enforce"
    allow_repairs: true
    allow_winsorize: true
    allow_clip_prices: true
    allow_fix_ohlc: true
    allow_drop_dupes: true
    allow_ffill_nans: true
    tolerate_outliers_after_repair: true
    fail_on_lookahead_flag: false  # relaxed to avoid false positives in synthetic smoke path
    fail_if_any_repair: false
    require_monotonic_dates: true
    tz: "UTC"
    price_max: 1000000.0

# Price validation limits
price_limits:
  max_price: 1000000.0  # Maximum allowed price (1M USD)
  min_price: 0.01       # Minimum allowed price (1 cent)
  max_daily_return: 0.3 # Maximum allowed daily return (30%)
  max_volume: 1000000000000  # Maximum allowed volume (1T shares)

# OHLC validation
ohlc_validation:
  max_high_low_spread: 0.4  # Maximum high-low spread as % of close (40%)
  require_ohlc_consistency: true  # Enforce low <= {open,close} <= high
  allow_zero_volume: false  # Whether to allow zero volume

# Outlier detection
outlier_detection:
  z_score_threshold: 4.0  # Z-score threshold for outlier detection
  mad_threshold: 3.0      # Median Absolute Deviation threshold
  min_obs_for_outlier: 20 # Minimum observations needed for outlier detection

# Repair behavior
repair_mode: "warn"  # Options: "warn", "drop", "fail", "winsorize"
winsorize_quantile: 0.01  # Quantile for winsorization (1% tail)

# Time series validation
time_series:
  require_monotonic: true  # Require strictly monotonic timestamps
  require_utc: true        # Require UTC timezone
  max_gap_days: 30         # Maximum allowed gap in days
  allow_duplicates: false  # Whether to allow duplicate timestamps

# Returns calculation
returns:
  method: "log_close_to_close"  # Always use log returns from close prices
  min_periods: 2               # Minimum periods for return calculation
  fill_method: "forward"       # How to handle missing returns

# Logging
logging:
  log_repairs: true           # Log all data repairs
  log_outliers: true          # Log detected outliers
  log_validation_failures: true  # Log validation failures
  summary_level: "INFO"       # Log level for summary statistics

# Performance monitoring (NEW)
performance:
  enabled: true               # Enable performance monitoring
  mode: "RELAXED"            # RELAXED or STRICT (can be overridden by SANITY_PERF_MODE env var)
  log_performance: true       # Log performance metrics
  track_memory: true          # Track memory usage
  performance_thresholds:
    100: 0.05                 # 100 rows: ≤ 0.05s
    1000: 0.20                # 1,000 rows: ≤ 0.20s
    10000: 0.60               # 10,000 rows: ≤ 0.60s
  memory_threshold: 250       # 10k rows: ≤ 250 MB RSS peak
  tolerance_modes:
    RELAXED: 0.30             # Allow up to +30% over thresholds
    STRICT: 0.10              # Allow up to +10% over thresholds
